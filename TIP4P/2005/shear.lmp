units real
atom_style full
boundary p p p

# package intel 1 omp 2

pair_style lj/cut/tip4p/long 1 2 1 1 0.1546 9.5

bond_style zero
angle_style zero
pair_modify tail yes

read_data /home/debian/water/TIP4P/2005/tip4p-implicit-225K.data

print "Initial configuration loaded."
reset_timestep 0
print "Applying shear rate: ${gamma}"
change_box all triclinic
kspace_style pppm/tip4p 1.0e-5

pair_coeff 1 1 0.18521 3.1589 #O-O
pair_coeff * 2 0.0 0.0

bond_coeff 1 0.9572 #O-H
angle_coeff 1 104.52 #H-O-H

group gH2O type 1 2
group gO type 1

neighbor 3.0 bin
neigh_modify delay 0 every 1 check yes

timestep 1.0
fix 1 gH2O shake 1.0e-4 100 10000 b 1 a 1

# # 系统弛豫到平衡态
# fix fnvt_equil all nvt temp ${T} ${T} 100.0
# thermo 1000
# thermo_style custom step temp etotal pe
# thermo_modify flush yes
# run 100000 # 100 ps
# unfix fnvt_equil

# 系统剪切变形

fix fdeform all deform 1 xy erate ${gamma} remap v
fix fnvt all nvt/sllod temp ${T} ${T} 100.0

compute tilt all temp/deform

variable L0_x equal lx
variable L0_y equal ly
variable L0_z equal lz

compute p all pressure NULL virial
variable sxy equal -c_p[4] * 1.01325e-4  # convert to GPa


variable strainInc equal 0.01
variable dt equal 1.0e-15
variable gammaSI equal ${gamma}*1e15
variable stepsPerReset equal ceil(${strainInc}/(${gammaSI}*${dt}))
print "Steps per reset: ${stepsPerReset}"

variable massAll equal mass(all)/6.022e23
variable volCm3 equal vol*1.0e-24
variable density_sys equal v_massAll/v_volCm3
variable tau_pa equal v_sxy * 1e9
variable gamma_s equal ${gamma} * 1e15
variable viscosity equal v_tau_pa / v_gamma_s

variable strain equal step*${gammaSI}*${dt}

thermo 1000
thermo_style custom step temp etotal pe pxy v_sxy v_strain v_viscosity
thermo_modify flush yes

dump traj all custom 200 traj_${gamma}_${T}.lammpstrj id type xu yu zu # 0.2ps
dump_modify traj sort id
fix stress all ave/time 500 1 500 v_strain v_sxy file stress_${gamma}_${T}.data  # 每0.5ps输出一次应力和应变

# compute peratom all stress/atom NULL
# dump stress gO custom 5000 stress_${gamma}_${T}.lammpstrj id type c_peratom[1] c_peratom[2] c_peratom[3] c_peratom[4] c_peratom[5] c_peratom[6]
# dump_modify stress sort id

variable Ttotal equal 1000000 # 1 ns
variable nloops equal ceil(${Ttotal}/(100000))
print "Total loops: ${nloops}"

variable nloop loop ${nloops}
label loop_start
run 100000 # 100ps
kspace_style pppm/tip4p 1.0e-5
next nloop
jump SELF loop_start
# run ${Ttotal}
# variable nloop loop ${nloops}
# label loop_start
# run ${stepsPerReset}
# kspace_style pppm/tip4p 1.0e-5
# next nloop
# jump SELF loop_start