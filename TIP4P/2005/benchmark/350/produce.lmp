# Improved LAMMPS script for Tanaka 2014 reproduction
# Target: T=200K, P=1bar, TIP4P/2005 water

units real
atom_style full 
boundary p p p

# Use data file for initial setup (ensure 512 molecules)
read_data ../../1H2O
replicate 8 8 8 
# Verify system has 512 molecules (1536 atoms total)

pair_style lj/cut/tip4p/long 1 2 1 1 0.1546 9.5
kspace_style pppm/tip4p 1.0e-5

bond_style harmonic
angle_style harmonic

pair_coeff 1 1 0.18521 3.1589 # O-O TIP4P/2005
pair_coeff 1 2 0.0 0.0       # O-H
pair_coeff 2 2 0.0 1.0       # H-H
pair_modify tail yes

bond_coeff 1 1000.0 0.9572   # O-H bond
angle_coeff 1 100.0 104.52   # H-O-H angle

group gH2O type 1 2
group gO type 1

neighbor 3.0 bin
neigh_modify delay 10 every 2 check yes

# Variables for monitoring
variable massAll equal mass(all)/6.022e23
variable volCm3 equal vol*1.0e-24
variable density_sys equal v_massAll/v_volCm3
variable tmp equal temp

timestep 2.0

# SHAKE constraints
fix 1 gH2O shake 1.0e-4 100 0 b 1 a 1

shell "mkdir production_output"
# ==================================================
# STEP 1: Initial equilibration at higher temperature
# ==================================================
print "Starting equilibration and produce at 350K..."

fix fnpt1 all npt temp 350.0 350.0 1000.0 iso 0.9869 0.9869 5000.0

thermo 1000
thermo_style custom step temp press vol density v_density_sys pe ke etotal
thermo_modify flush yes

# More frequent sampling for structural analysis (every 1000 steps = 2ps)
dump dH2O gH2O custom 1000 production_output/dump_H2O_200K_1bar.lammpstrj id type xu yu zu vx vy vz
dump_modify dH2O sort id

# Average properties
fix fdensity gH2O ave/time 500 100 50000 v_density_sys file production_output/density_200K_1bar.dat
fix ftemp all ave/time 500 100 50000 v_tmp file production_output/temperature_200K_1bar.dat

# Radial distribution function
compute rdf1 gO rdf 200 1 1 cutoff 10.0
fix frdf gO ave/time 500 100 50000 c_rdf1[*] file production_output/rdf_OO_200K_1bar.dat mode vector


run 100000000  # 200 ns equilibration at 300K
write_data production_output/final_350K_1bar_tip4p2005.data velocity

# # ==================================================
# # STEP 2: Cooling to target temperature
# # ==================================================
# print "Cooling from 300K to 200K..."

# # Gradual cooling
# fix fnpt2 all npt temp 300.0 250.0 1000.0 iso 1.01325 1.01325 5000.0
# run 5000000  # 10 ns cooling to 250K

# fix fnpt3 all npt temp 250.0 200.0 1000.0 iso 1.01325 0.9869 5000.0
# run 10000000  # 20 ns cooling to 200K

# # ==================================================
# # STEP 3: Equilibration at target conditions
# # ==================================================
# print "Equilibrating at 200K, 1bar..."

# unfix fnpt3
# fix fnpt_final all npt temp 200.0 200.0 1000.0 iso 0.9869 0.9869 5000.0

# # Monitor density convergence
# fix fdensity_eq gH2O ave/time 1000 50 50000 v_density_sys file equilibration_density.dat

# run 50000000  # 100 ns equilibration at target conditions

# # ==================================================
# # STEP 4: Production run
# # ==================================================
# print "Starting production run..."

# # Reset timestep counter for production
# reset_timestep 0

# # Setup output
# shell "mkdir -p production_output"

# # More frequent sampling for structural analysis (every 1000 steps = 2ps)
# dump dH2O gH2O custom 1000 production_output/dump_H2O_200K_1bar.lammpstrj id type xu yu zu vx vy vz
# dump_modify dH2O sort id

# # Average properties
# fix fdensity gH2O ave/time 500 100 50000 v_density_sys file production_output/density_200K_1bar.dat
# fix ftemp all ave/time 500 100 50000 v_tmp file production_output/temperature_200K_1bar.dat

# # Radial distribution function
# compute rdf1 gO rdf 200 1 1 cutoff 10.0
# fix frdf gO ave/time 500 100 50000 c_rdf1[*] file production_output/rdf_OO_200K_1bar.dat mode vector

# # Restart files
# restart 25000000 production_output/restart_200K_1bar_*

# # Extended production run (following paper's recommendation)
# run 250000000  # 500 ns production run

# write_restart production_output/final_200K_1bar_tip4p2005.restart

print "Production run completed!"

# ==================================================
# Analysis summary
# ==================================================
print "Simulation Summary:"
print "- Model: TIP4P/2005"
print "- Temperature: 350 K"
print "- Pressure: 1 bar (0.9869 atm)"
print "- Total production time: 500 ns"
print "- Trajectory sampling: every 2 ps"
print "- Output files in production_output/ directory"